@using System.ComponentModel.DataAnnotations;
@using ScratchCard.File;
@using NPOI.Util;
@using AntDesign;
@using Minio;
@using BlazorDownloadFile;

@inject MinioUtil _minioUtil;
@inject IBlazorDownloadFileService _downloadFileService;
@inject MessageService _message;
@inject IConfiguration _configuration;

@page "/card"
@rendermode InteractiveServer

<PageTitle>ScratchCard</PageTitle>

<div class="page-content">
    <Steps Current="@step" Class="site-navigation-steps">
        @foreach (string title in stepTitles)
        {
            <Step Title="@title" />
        }
    </Steps>

    @if (step < 2)
    {
        <div class="form-content">
            <Form Class="steps-content" Model="@card" Layout="@FormLayout.Vertical">
                @switch (step)
                {
                    case 0:
                        {
                            <FormItem Required Label="刮刮卡的长度">
                                <AntDesign.InputNumber Step="0" Width="100%" Value="@card.Length" DefaultValue="1" Min="1" ValueChanged="(int number)=>{card.Length = number;}" />
                            </FormItem>
                            <FormItem Required Label="刮刮卡的宽度">
                                <AntDesign.InputNumber Step="0" Width="100%" Value="@card.Width" DefaultValue="1" Min="1" ValueChanged="(int number)=>{card.Width = number;}" />
                            </FormItem>
                            <FormItem Required Label="奖品种类数目">
                                <AntDesign.InputNumber Step="0" Width="100%" Value="@awardTypeNumber" DefaultValue="1" Min="1" ValueChanged="(int number )=>AwardTypeNumberOnChange(number)" />
                            </FormItem>
                            break;
                        }
                    case 1:
                        {
                            <FormItem>
                                <Table DataSource="@card.Awards" TItem="Model.Award" Context="row" HidePagination Bordered>
                                    <PropertyColumn Property="c=>c.Name" Title="奖品名称" Width="50%">
                                        <FormItem Required>
                                            <Input Value="@row.Name" ValueChanged="(string name)=>{row.Name = name;}" />
                                        </FormItem>
                                    </PropertyColumn>

                                    <PropertyColumn Property="c=>c.Number" Title="奖品数量" Width="50%">
                                        <FormItem Required>
                                            <AntDesign.InputNumber Min="1" Step="0" Width="100%" Value="@row.Number" ValueChanged="(int number)=>{row.Number = number;}" />
                                        </FormItem>
                                    </PropertyColumn>
                                </Table>
                            </FormItem>
                            break;
                        }
                }
            </Form>
        </div>
        <div class="steps-footer">
            <Flex Align="center" Justify="center">
                <Space Align="@SpaceAlign.Center" Size="@SpaceSize.Large">
                    <SpaceItem>
                        <Button Type="@ButtonType.Default"
                                OnClick="PrevStep">
                            上一步
                        </Button>
                    </SpaceItem>
                    <SpaceItem>
                        <Button Type="@ButtonType.Primary"
                                OnClick="NextStep">
                            下一步
                        </Button>
                    </SpaceItem>
                </Space>
            </Flex>
        </div>
    }
    else
    {
        <Result Status="success"
                Title="成功生成刮刮卡！" Style="margin-top:60px">
            <Extra>
                <Button Type="primary" Icon="cloud-download" OnClick="DownLoadFile">点击下载Excel文件</Button>
            </Extra>
        </Result>
    }
</div>

<style>
    .page-content {
        padding-top: 16px;
        padding-left: 10px;
        padding-right: 10px;
        padding-bottom: 88px;
    }

    .steps-content {
        margin-top: 32px;
        min-height: 100px;
        text-align: center;
    }

    .steps-action {
        margin-top: 24px;
    }

    .form-content {
        margin-top: 10px;
        height: 300px;
        overflow: auto;
    }

    .steps-footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 12px 10px;
        border-top: 1px solid var(--ant-color-split);
        background-color: var(--ant-color-bg-container);
    }
</style>

@code {
    //当前步骤
    private int step = 0;

    //步骤名称
    private string[] stepTitles = new string[] { "设置卡片", "设置奖品", "完成" };

    //奖品种类数目
    private int awardTypeNumber = 0;

    private Model.Card card = new Model.Card();

    //文件路径
    private string filePath = string.Empty;

    private string BucketName =>
        string.IsNullOrWhiteSpace(_configuration["MinioSettings:Bucket"])
            ? Environment.UserName
            : _configuration["MinioSettings:Bucket"]!;

    /// <summary>
    /// 下一步
    /// </summary>
    private async Task NextStep()
    {
        if (step == 0)
        {
            if (!await ValidateStep0())
            {
                return;
            }

            step++;
            return;
        }

        if (step == 1)
        {
            if (!await ValidateStep1())
            {
                return;
            }

            step++;

            if (step != 2)
            {
                return;
            }

            try
            {
                AssignUniquePositions(card);

                //本地生成文件
                filePath = FileUtil.GetFilePath();
                FileUtil.GenerateExcelFile(card, filePath);

                //上传文件至minio（等待完成，避免下载时对象尚未可用）
                await _minioUtil.UploadFileAsync(BucketName, filePath);
            }
            catch (Exception ex)
            {
                step = 1;
                await _message.Error($"生成或上传失败：{ex.Message}");
            }
        }
    }

    private async Task<bool> ValidateStep0()
    {
        if (card.Length <= 0)
        {
            await _message.Error("刮刮卡长度必须为正整数");
            return false;
        }

        if (card.Width <= 0)
        {
            await _message.Error("刮刮卡宽度必须为正整数");
            return false;
        }

        if (awardTypeNumber <= 0)
        {
            await _message.Error("奖品种类数目必须为正整数");
            return false;
        }

        int totalCells = card.Length * card.Width;
        if (awardTypeNumber > totalCells)
        {
            await _message.Error($"奖品种类数目不可大于总格子数：{totalCells}");
            return false;
        }

        return true;
    }

    private async Task<bool> ValidateStep1()
    {
        if (card.Awards.Count != awardTypeNumber)
        {
            await _message.Error("奖品列表未初始化，请返回上一步重新设置奖品种类数");
            return false;
        }

        var names = new HashSet<string>(StringComparer.Ordinal);
        foreach (var award in card.Awards)
        {
            if (string.IsNullOrWhiteSpace(award.Name))
            {
                await _message.Error("奖品名称不可为空");
                return false;
            }

            string trimmed = award.Name.Trim();
            if (!names.Add(trimmed))
            {
                await _message.Error($"奖品名称不可重复：{trimmed}");
                return false;
            }

            if (award.Number <= 0)
            {
                await _message.Error($"奖品“{trimmed}”数量必须为正整数");
                return false;
            }
        }

        int totalCells = card.Length * card.Width;
        int totalAwards = card.Awards.Sum(a => a.Number);
        if (totalAwards > totalCells)
        {
            await _message.Error($"奖品数量不可超过总格子数：{totalCells}，当前奖品数量：{totalAwards}");
            return false;
        }

        return true;
    }

    private static void AssignUniquePositions(Model.Card card)
    {
        int totalCells = card.Length * card.Width;
        int totalAwards = card.Awards.Sum(a => a.Number);
        if (totalAwards > totalCells)
        {
            throw new InvalidOperationException($"奖品数量不可超过总格子数！总格子数：{totalCells},奖品数量：{totalAwards}");
        }

        var allCells = new List<(int X, int Y)>(totalCells);
        for (int y = 0; y < card.Width; y++)
        {
            for (int x = 0; x < card.Length; x++)
            {
                allCells.Add((x, y));
            }
        }

        for (int i = allCells.Count - 1; i > 0; i--)
        {
            int j = Random.Shared.Next(i + 1);
            (allCells[i], allCells[j]) = (allCells[j], allCells[i]);
        }

        int index = 0;
        foreach (Model.Award award in card.Awards)
        {
            award.AwardPositions.Clear();
            for (int k = 0; k < award.Number; k++)
            {
                var (x, y) = allCells[index++];
                award.AwardPositions.Add(new Model.AwardPosition { PositionX = x, PositionY = y });
            }
        }
    }

    /// <summary>
    /// 上一步
    /// </summary>
    private void PrevStep()
    {
        step = step - 1 < 0 ? 0 : step - 1;
    }

    /// <summary>
    /// 设置奖品种类
    /// </summary>
    /// <param name="number">奖品数量</param>
    private void AwardTypeNumberOnChange(int number)
    {
        card.Awards.Clear();

        for (int i = 0; i < number; i++)
        {
            Model.Award award = new Award();
            award.Length = card.Length;
            award.Width = card.Width;

            card.Awards.Add(award);
        }

        awardTypeNumber = number;
    }

    /// <summary>
    /// 下载文件
    /// </summary>
    /// <returns></returns>
    private async Task DownLoadFile()
    {
        if (string.IsNullOrWhiteSpace(filePath))
        {
            await _message.Error("尚未生成文件");
            return;
        }

        MemoryStream memoryStream = new MemoryStream();
        string fileName = Path.GetFileName(filePath);
        await _minioUtil.DownloadFile(BucketName, fileName, memoryStream);
        memoryStream.Position = 0;
        await _downloadFileService.DownloadFile(fileName, memoryStream, "application/octet-stream");
    }
}
